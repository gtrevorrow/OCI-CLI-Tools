<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="1000" viewBox="0 0 1600 1000" font-family="Segoe UI, Roboto, Arial">
  <rect width="1600" height="1000" fill="white"/>
  <defs>
    <marker id="arrow-black" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
      <path d="M0,0 L6,3 L0,6 Z" fill="#222"/>
    </marker>
    <marker id="arrow-red" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
      <path d="M0,0 L6,3 L0,6 Z" fill="#b33"/>
    </marker>
    <marker id="arrow-orange" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
      <path d="M0,0 L6,3 L0,6 Z" fill="#ffb300"/>
    </marker>
  </defs>

  <!-- Title -->
  <text x="50" y="30" font-size="18" fill="#1a1a1a" font-weight="600">Sequence Diagram: woci (oci_upst_session_manager.py) Workflow</text>

  <!-- Participants -->
  <g id="participants">
    <text x="100" y="70" font-size="14" fill="#333" text-anchor="middle">User</text>
    <line x1="100" y1="80" x2="100" y2="950" stroke="#333" stroke-width="2"/>

    <text x="295" y="70" font-size="14" fill="#333" text-anchor="middle">woci Script</text>
    <line x1="295" y1="80" x2="295" y2="950" stroke="#333" stroke-width="2"/>

    <text x="490" y="70" font-size="14" fill="#333" text-anchor="middle">Browser</text>
    <line x1="490" y1="80" x2="490" y2="950" stroke="#333" stroke-width="2"/>

    <text x="685" y="70" font-size="14" fill="#333" text-anchor="middle">OIDC Provider</text>
    <line x1="685" y1="80" x2="685" y2="950" stroke="#333" stroke-width="2"/>

    <text x="880" y="70" font-size="14" fill="#333" text-anchor="middle">OCI Domain</text>
    <line x1="880" y1="80" x2="880" y2="950" stroke="#333" stroke-width="2"/>

    <text x="1075" y="70" font-size="14" fill="#333" text-anchor="middle">OCI CLI</text>
    <line x1="1075" y1="80" x2="1075" y2="950" stroke="#333" stroke-width="2"/>

    <text x="1270" y="70" font-size="14" fill="#333" text-anchor="middle">OCI Services</text>
    <line x1="1270" y1="80" x2="1270" y2="950" stroke="#333" stroke-width="2"/>
  </g>

  <!-- Messages -->
  <g id="messages">
    <!-- 1. User runs woci -->
    <line x1="100" y1="100" x2="295" y2="100" stroke="#222" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="197.5" y="95" font-size="12" fill="#333">run woci command</text>

    <!-- 2. Parse args, load config -->
    <line x1="295" y1="120" x2="295" y2="140" stroke="#27a27a" stroke-width="2"/>
    <text x="305" y="135" font-size="12" fill="#27a27a">parse args, load woci_manager.ini</text>

    <!-- 3. Check for existing session -->
    <line x1="295" y1="150" x2="295" y2="170" stroke="#27a27a" stroke-width="2"/>
    <text x="305" y="165" font-size="12" fill="#27a27a">check for existing UPST token</text>

    <!-- 4a. If no session: open browser -->
    <line x1="295" y1="180" x2="490" y2="180" stroke="#222" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="392.5" y="175" font-size="12" fill="#333">open auth URL in browser</text>

    <!-- 5. Browser displays login -->
    <line x1="490" y1="200" x2="100" y2="200" stroke="#222" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="295" y="195" font-size="12" fill="#333">display login page</text>

    <!-- 6. User logs in -->
    <line x1="100" y1="220" x2="490" y2="220" stroke="#222" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="295" y="215" font-size="12" fill="#333">user authenticates</text>

    <!-- 7. Browser redirects to OAuth server -->
    <line x1="490" y1="240" x2="685" y2="240" stroke="#222" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="587.5" y="235" font-size="12" fill="#333">redirect with auth code</text>

    <!-- 8. OAuth server sends code to woci callback -->
    <line x1="685" y1="260" x2="295" y2="260" stroke="#222" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="490" y="255" font-size="12" fill="#333">callback with code</text>

    <!-- 9. Exchange code for JWT + refresh_token -->
    <line x1="295" y1="280" x2="685" y2="280" stroke="#b33" stroke-width="2" marker-end="url(#arrow-red)"/>
    <text x="490" y="275" font-size="12" fill="#b33">exchange code for JWT + refresh_token</text>

    <!-- 10. Exchange JWT for UPST -->
    <line x1="295" y1="300" x2="880" y2="300" stroke="#b33" stroke-width="2" marker-end="url(#arrow-red)"/>
    <text x="587.5" y="295" font-size="12" fill="#b33">RFC8693 exchange JWT → UPST</text>

    <!-- 11. Save tokens and keys -->
    <line x1="295" y1="320" x2="295" y2="340" stroke="#27a27a" stroke-width="2"/>
    <text x="305" y="335" font-size="12" fill="#27a27a">save UPST, refresh_token, private_key.pem</text>

    <!-- 12. If refresh_interval > 0, start background thread -->
    <line x1="295" y1="350" x2="295" y2="370" stroke="#ffb300" stroke-width="2"/>
    <text x="305" y="365" font-size="12" fill="#ffb300">start background refresh thread (if enabled)</text>

    <!-- Background loop (dashed) -->
    <line x1="295" y1="380" x2="295" y2="420" stroke="#ffb300" stroke-width="2" stroke-dasharray="5,5"/>
    <text x="305" y="405" font-size="12" fill="#ffb300">loop: wait interval, refresh_token → new UPST</text>

    <!-- 13. Invoke OCI CLI -->
    <line x1="295" y1="430" x2="1075" y2="430" stroke="#222" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="685" y="425" font-size="12" fill="#333">invoke oci --auth security_token --profile ... + args</text>

    <!-- 14. OCI CLI calls OCI Services -->
    <line x1="1075" y1="450" x2="1270" y2="450" stroke="#222" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="1172.5" y="445" font-size="12" fill="#333">API request</text>

    <!-- 15. OCI Services responds -->
    <line x1="1270" y1="470" x2="1075" y2="470" stroke="#222" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="1172.5" y="465" font-size="12" fill="#333">API response</text>

    <!-- 16. OCI CLI exits -->
    <line x1="1075" y1="490" x2="295" y2="490" stroke="#222" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="685" y="485" font-size="12" fill="#333">exit with output</text>

    <!-- 17. woci outputs to user -->
    <line x1="295" y1="510" x2="100" y2="510" stroke="#222" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="197.5" y="505" font-size="12" fill="#333">command output</text>
  </g>

  <!-- Notes -->
  <g id="notes">
    <rect x="1300" y="100" width="281" height="150" rx="10" fill="#f0f0f0" stroke="#ccc"/>
    <text x="1310" y="120" font-size="12" fill="#333" font-weight="600">Notes:</text>
    <text x="1310" y="140" font-size="11" fill="#333">• Auth flow uses Authorization Code + PKCE</text>
    <text x="1310" y="155" font-size="11" fill="#333">• Token exchange follows RFC8693 profile</text>
    <text x="1310" y="170" font-size="11" fill="#333">• Background refresh uses refresh_token</text>
    <text x="1310" y="185" font-size="11" fill="#333">• Session artifacts stored in ~/.oci/sessions/</text>
    <text x="1310" y="200" font-size="11" fill="#333">• OCI config updated with key_file, security_token_file</text>
    <text x="1310" y="215" font-size="11" fill="#333">• Refresh interval defaults to 0 (disabled)</text>
    <text x="1310" y="230" font-size="11" fill="#333">• Refresh token optionally encrypted</text>
  </g>
</svg>

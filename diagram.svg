<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="1000" viewBox="0 0 1600 1000" font-family="Segoe UI, Roboto, Arial">
  <rect width="1600" height="1000" fill="black"/>
  <defs>
    <marker id="arrow-black" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
      <path d="M0,0 L6,3 L0,6 Z" fill="white"/>
    </marker>
    <marker id="arrow-red" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
      <path d="M0,0 L6,3 L0,6 Z" fill="#b33"/>
    </marker>
    <marker id="arrow-orange" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
      <path d="M0,0 L6,3 L0,6 Z" fill="#ffb300"/>
    </marker>
  </defs>

  <!-- Title -->
  <text x="50" y="30" font-size="18" fill="white" font-weight="600">Sequence Diagram: woci Initial Authentication (No Valid Session/Refresh Token)</text>

  <!-- Participants -->
  <g id="participants">
    <text x="100" y="70" font-size="14" fill="white" text-anchor="middle">User</text>
    <line x1="100" y1="80" x2="100" y2="950" stroke="white" stroke-width="2"/>

    <text x="295" y="70" font-size="14" fill="white" text-anchor="middle">woci Script</text>
    <line x1="295" y1="80" x2="295" y2="950" stroke="white" stroke-width="2"/>

    <text x="490" y="70" font-size="14" fill="white" text-anchor="middle">Browser</text>
    <line x1="490" y1="80" x2="490" y2="950" stroke="white" stroke-width="2"/>

    <text x="685" y="70" font-size="14" fill="white" text-anchor="middle">OIDC Provider</text>
    <line x1="685" y1="80" x2="685" y2="950" stroke="white" stroke-width="2"/>

    <text x="880" y="70" font-size="14" fill="white" text-anchor="middle">OCI Domain</text>
    <line x1="880" y1="80" x2="880" y2="950" stroke="white" stroke-width="2"/>

    <text x="1075" y="70" font-size="14" fill="white" text-anchor="middle">OCI CLI</text>
    <line x1="1075" y1="80" x2="1075" y2="950" stroke="white" stroke-width="2"/>

    <text x="1270" y="70" font-size="14" fill="white" text-anchor="middle">OCI Services</text>
    <line x1="1270" y1="80" x2="1270" y2="950" stroke="white" stroke-width="2"/>
  </g>

  <!-- Messages -->
  <g id="messages">
    <!-- 1. User runs woci -->
    <line x1="100" y1="120" x2="295" y2="120" stroke="white" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="110" y="110" font-size="12" fill="white" text-anchor="start">run woci command</text>

    <!-- 2. Parse args, load config -->
    <line x1="295" y1="180" x2="295" y2="220" stroke="#27a27a" stroke-width="2"/>
    <text x="305" y="170" font-size="12" fill="white" text-anchor="start">parse args, load woci_manager.ini</text>

    <!-- 3. Check for existing session -->
    <line x1="295" y1="240" x2="295" y2="280" stroke="#27a27a" stroke-width="2"/>
    <text x="305" y="230" font-size="12" fill="white" text-anchor="start">check for UPST token AND refresh_token</text>
    <text x="305" y="245" font-size="11" fill="#ffb300" text-anchor="start">(none found - start auth flow)</text>

    <!-- 4a. If no session: open browser -->
    <line x1="295" y1="320" x2="490" y2="320" stroke="white" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="305" y="310" font-size="12" fill="white" text-anchor="start">open auth URL in browser</text>

    <!-- 5. Browser displays login -->
    <line x1="685" y1="360" x2="490" y2="360" stroke="white" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="675" y="350" font-size="12" fill="white" text-anchor="end">display login page</text>

    <!-- 6. User logs in -->
    <line x1="100" y1="400" x2="685" y2="400" stroke="white" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="110" y="390" font-size="12" fill="white" text-anchor="start">user authenticates</text>

    <!-- 7. Browser redirects to OAuth server -->
    <line x1="490" y1="440" x2="685" y2="440" stroke="white" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="500" y="430" font-size="12" fill="white" text-anchor="start">redirect with auth code</text>

    <!-- 8. OAuth server sends code to woci callback -->
    <line x1="685" y1="480" x2="295" y2="480" stroke="white" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="675" y="470" font-size="12" fill="white" text-anchor="end">callback with code</text>

    <!-- 9. Exchange code for JWT + refresh_token -->
    <line x1="295" y1="520" x2="685" y2="520" stroke="#b33" stroke-width="2" marker-end="url(#arrow-red)"/>
    <text x="305" y="510" font-size="12" fill="white" text-anchor="start">exchange code for access_token (JWT) + refresh_token (id_token also returned)</text>

    <!-- 10. Exchange JWT for UPST -->
    <line x1="295" y1="560" x2="880" y2="560" stroke="#b33" stroke-width="2" marker-end="url(#arrow-red)"/>
    <text x="305" y="550" font-size="12" fill="white" text-anchor="start">RFC8693 exchange access_token (JWT) → UPST</text>

    <!-- 11. Save tokens and keys -->
    <line x1="295" y1="600" x2="295" y2="640" stroke="#27a27a" stroke-width="2"/>
    <text x="305" y="590" font-size="12" fill="white" text-anchor="start">save UPST, refresh_token, private_key.pem</text>

    <!-- 13. Invoke OCI CLI -->
    <line x1="295" y1="660" x2="1075" y2="660" stroke="white" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="305" y="650" font-size="12" fill="white" text-anchor="start">invoke oci --auth security_token --profile ... + args</text>

    <!-- 14. OCI CLI calls OCI Services -->
    <line x1="1075" y1="720" x2="1270" y2="720" stroke="white" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="1085" y="710" font-size="12" fill="white" text-anchor="start">API request</text>

    <!-- 15. OCI Services responds -->
    <line x1="1270" y1="780" x2="1075" y2="780" stroke="white" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="1260" y="770" font-size="12" fill="white" text-anchor="end">API response</text>

    <!-- 16. OCI CLI exits -->
    <line x1="1075" y1="840" x2="295" y2="840" stroke="white" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="1065" y="830" font-size="12" fill="white" text-anchor="end">exit with output</text>

    <!-- 17. woci outputs to user -->
    <line x1="295" y1="900" x2="100" y2="900" stroke="white" stroke-width="2" marker-end="url(#arrow-black)"/>
    <text x="285" y="890" font-size="12" fill="white" text-anchor="end">command output</text>
  </g>

  <!-- Notes -->
  <g id="notes">
    <rect x="1300" y="100" width="281" height="165" rx="10" fill="#333" stroke="#333"/>
    <text x="1310" y="120" font-size="12" fill="white" font-weight="600">Notes:</text>
    <text x="1310" y="140" font-size="11" fill="white">• Auth flow uses Authorization Code + PKCE</text>
    <text x="1310" y="155" font-size="11" fill="white">• Token exchange follows RFC8693 profile</text>
    <text x="1310" y="170" font-size="11" fill="white">• Refresh token used for silent token renewal</text>
    <text x="1310" y="185" font-size="11" fill="white">• Session artifacts stored in ~/.oci/sessions/</text>
    <text x="1310" y="200" font-size="11" fill="white">• OCI config updated with key_file, security_token_file</text>
    <text x="1310" y="215" font-size="11" fill="white">• Refresh token optionally encrypted (AES-GCM)</text>
    <text x="1310" y="230" font-size="11" fill="white">• Okta: requires offline_access scope for refresh token</text>
    <text x="1310" y="245" font-size="11" fill="white">• Okta rotates refresh tokens (handled automatically)</text>
  </g>
</svg>
